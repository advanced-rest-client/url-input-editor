<!--
@license
Copyright 2018 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/legacy/class.html"
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../events-target-behavior/events-target-behavior.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../url-parser/url-parser.html">
<link rel="import" href="../events-target-behavior/events-target-behavior.html">
<link rel="import" href="url-detailed-editor.html">
<dom-module id="url-input-editor">
  <template>
    <style>
    :host {
      @apply --layout-vertical;
      position: relative;
      @apply --url-input-editor;
    }

    .main-input,
    .editor {
      @apply --layout-flex;
    }

    paper-autocomplete {
      bottom: 0;
    }

    .toggle-button {
      @apply --toggle-button;
      margin-top: 16px;
    }

    .toggle-button:hover {
      @apply --toggle-button-hover;
    }

    iron-collapse.sized {
      min-height: 48px;
    }

    [hidden] {
      display: none !important;
    }

    .container {
      @apply --layout-horizontal;
    }
    </style>
    <div class="container">
      <div class="editor">
        <paper-input label="Request URL" readonly="[[readonly]]" value="{{value}}" class="main-input" required auto-validate error-message="An URL is required." on-blur="_ensureUrlHasProtocol" on-focus="_mainFocus" hidden="[[detailsOpened]]"></paper-input>
        <paper-autocomplete loader open-on-focus target="[[_autocompleteTarget]]" on-query="_autocompleteQuery" opened="{{suggesionsOpened}}"></paper-autocomplete>
        <iron-collapse id="collapse" opened="[[detailsOpened]]" transitioning="{{colapseTransitioning}}">
          <url-detailed-editor value="{{value}}" query-parameters="{{queryParameters}}" on-url-encode="encodeParameters" on-url-decode="decodeParameters" readonly="[[readonly]]"></url-detailed-editor>
        </iron-collapse>
      </div>
      <paper-icon-button class="toggle-button" icon="arc:keyboard-arrow-down" on-click="toggle" title="Toggle detailed editor"></paper-icon-button>
    </div>
  </template>
  <script>
  /**
   * The request URL editor
   *
   * The editor renders a simple editor view with an input field. The input
   * uses `paper-autocomplete` element to render URL suggestions.
   *
   * When setting `detailsOpened` property to `true` it renders detailed editor.
   * The editor allows to edit host, path, query parameetrs and hash
   * separatelly.
   *
   * ### Example
   *
   * ```html
   * <url-input-editor
   *  url="{{requestURL}}"
   *  on-send-request="_sendAction"
   *  on-url-value-changed="_handleNewUrl"></url-input-editor>
   * ```
   *
   * ### Styling
   *
   * `<url-input-editor>` provides the following custom properties and mixins
   * for styling:
   *
   * Custom property | Description | Default
   * ----------------|-------------|----------
   * `--url-input-editor` | Mixin applied to the element | `{}`
   *
   * Use paper elements mixin to style this element.
   *
   * @polymer
   * @customElement
   * @memberof UiElements
   * @demo demo/index.html
   * @appliesMixin Polymer.IronValidatableBehavior
   * @appliesMixin ArcBehaviors.EventsTargetBehavior
   */
  class UrlInputEditor extends
    ArcBehaviors.EventsTargetBehavior(
      Polymer.mixinBehaviors([Polymer.IronValidatableBehavior], Polymer.Element)) {
    static get is() {return 'url-input-editor';}
    static get properties() {
      return {
        // Current URL value.
        value: {
          type: String,
          notify: true,
          observer: '_onValueChanged'
        },
        /**
         * True if detailed editor is opened.
         */
        detailsOpened: {
          type: Boolean,
          observer: '_detailsOpenedChanged'
        },
        /**
         * Default protocol for the URL if it's missing.
         */
        defaultProtocol: {
          type: String,
          value: 'http'
        },
        /**
         * Input target for the `paper-autocomplete` element.
         */
        _autocompleteTarget: HTMLElement,
        // True when a suggestion box for the URL is opened.
        suggesionsOpened: {
          type: Boolean,
          notify: true
        },
        // Controlled by the collapse element flad used to animate detail panel.
        colapseTransitioning: {
          type: Boolean,
          observer: '_colapseTransitioning'
        },
        /**
         * List of query parameters model.
         * It is passed to detailed editor to build query parameters form.
         * If not set then it is computed from current URL.
         *
         * Model for query parameters is:
         * - name {String} param name
         * - value {String} param value
         * - enabled {Boolean} is param included into the `value`
         */
        queryParameters: {
          type: Array,
          notify: true
        },
        /**
         * When set the editor is in read only mode.
         */
        readonly: Boolean
      };
    }

    constructor() {
      super();
      this._extValueChangedHandler = this._extValueChangedHandler.bind(this);
      this._keyDownHandler = this._keyDownHandler.bind(this);
    }

    _attachListeners(node) {
      this._autocompleteTarget = this.shadowRoot.querySelector('.main-input');
      node.addEventListener('url-value-changed', this._extValueChangedHandler);
      this.addEventListener('keydown', this._keyDownHandler);
    }

    _detachListeners(node) {
      this._autocompleteTarget = undefined;
      node.removeEventListener('url-value-changed', this._extValueChangedHandler);
      this.removeEventListener('keydown', this._keyDownHandler);
    }

    /**
     * A handler that is called on input
     *
     * @param {String} value
     */
    _onValueChanged(value) {
      if (this._preventValueChangeEvent || this.readonly) {
        return;
      }
      this.dispatchEvent(new CustomEvent('url-value-changed', {
        bubbles: true,
        composed: true,
        detail: {
          value: value,
          queryParameters: this.queryParameters
        }
      }));
    }

    /**
     * A handler for the `url-value-changed` event.
     * If this element is not the source of the event then it will update the `value` property.
     * It's to be used besides the Polymer's data binding system.
     *
     * @param {CustomEvent} e
     */
    _extValueChangedHandler(e) {
      if (e.composedPath()[0] === this || this.readonly) {
        return;
      }
      this._preventValueChangeEvent = true;
      this.set('value', e.detail.value);
      this._preventValueChangeEvent = false;
    }

    /**
     * Opens detailed view.
     */
    toggle() {
      this.detailsOpened = !this.detailsOpened;
    }

    /**
     * HTTP encode query parameters
     */
    encodeParameters() {
      if (this.readonly) {
        return;
      }
      this._decodeEncode('encode');
      this.dispatchEvent(new CustomEvent('send-analytics', {
        bubbles: true,
        composed: true,
        detail: {
          type: 'event',
          category: 'Request view',
          action: 'URL widget context menu action',
          label: 'Encode parameters'
        }
      }));
    }

    /**
     * HTTP decode query parameters
     */
    decodeParameters() {
      if (this.readonly) {
        return;
      }
      this._decodeEncode('decode');
      this.dispatchEvent(new CustomEvent('send-analytics', {
        bubbles: true,
        composed: true,
        detail: {
          type: 'event',
          category: 'Request view',
          action: 'URL widget context menu action',
          label: 'Decode parameters'
        }
      }));
    }

    /**
     * HTTP encode or decode query parameters depending on [type].
     *
     * @param {String} type
     */
    _decodeEncode(type) {
      const url = this.value;
      if (!url) {
        return;
      }
      /* global UrlParser */
      const parser = new UrlParser(url);
      if (type === 'decode') {
        this._decode(parser);
      } else {
        this._encode(parser);
      }
    }

    _decode(parser) {
      const decoded = parser.searchParams.map((item) => {
        const _key = this.decodeQueryString(item[0]);
        const _value = this.decodeQueryString(item[1]);
        return [_key, _value];
      });
      parser.searchParams = decoded;
      const path = parser.path;
      if (path) {
        parser.path = path.split('/')
        .map((item) => this.decodeQueryString(item))
        .join('/');
      }
      this.set('value', parser.value);
    }

    _encode(parser) {
      const encoded = parser.searchParams.map((item) => {
        const _key = this.encodeQueryString(item[0]);
        const _value = this.encodeQueryString(item[1]);
        return [_key, _value];
      });
      parser.searchParams = encoded;
      const path = parser.path;
      if (path) {
        parser.path = '/' + path.split('/')
        .map((item) => {
          if (!item) {
            return;
          }
          return this.encodeQueryString(item);
        })
        .filter((item) => !!item)
        .join('/');
      }
      this.set('value', parser.value);
    }
    /**
     * Ensures the URL has protocol value when detailed editor closes.
     * @param {Boolean} detailsOpened
     */
    _detailsOpenedChanged(detailsOpened) {
      if (detailsOpened) {
        return;
      }
      this._ensureUrlHasProtocol();
    }
    /**
     * Handler for autocomplete element query event.
     * Dispatches `url-history-query` to query history model for data.
     * @param {CustomEvent} e
     */
    _autocompleteQuery(e) {
      e.preventDefault();
      e.stopPropagation();
      const autocomplete = e.target;
      if (!e.detail.value) {
        autocomplete.source = [];
        return;
      }
      const ev = new CustomEvent('url-history-query', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          q: e.detail.value
        }
      });
      this.dispatchEvent(ev);
      ev.detail.result
      .then((result) => {
        result = result.map((item) => item.url);
        autocomplete.source = result;
      })
      .catch(() => {
        autocomplete.source = [];
      });
    }
    /**
     * Ensures that the URL has a protocol.
     * The detault protocol is defined in `defaultProtocol` property.
     * The protocol is inserted into the URL value only if the value is not a
     * path and it's not a variable.
     *
     * @return {undefined} It updates the `url` property.
     */
    _ensureUrlHasProtocol() {
      if (this.readonly) {
        return;
      }
      let url = this.value;
      if (url.indexOf('http') !== 0) {
        if (url[0] !== '/' && url[0] !== '$' && url[0] !== '{') {
          url = this.defaultProtocol + '://' + url;
          this.set('value', url);
        }
      }
    }
    /**
     * Ensures that protocol is set before user input.
     *
     * @param {Event} e
     */
    _mainFocus(e) {
      if (!this.value && !this.readonly) {
        this.value = this.defaultProtocol + '://';
        e.target.inputElement.inputElement.setSelectionRange(0, this.value.length);
      }
    }

    _keyDownHandler(e) {
      const target = e.composedPath()[0];
      if (target.nodeName !== 'INPUT') {
        return;
      }
      if (e.keyCode !== 13) {
        return;
      }
      this._onEnter();
    }
    /**
     * A handler called when the user press "enter" in any of the form fields.
     * This will send a `send` event.
     */
    _onEnter() {
      if (this.suggesionsOpened) {
        return;
      }
      this.dispatchEvent(new CustomEvent('send-request', {
        bubbles: true,
        composed: true
      }));
    }
    /**
     * Returns a string where all characters that are not valid for a URL
     * component have been escaped. The escaping of a character is done by
     * converting it into its UTF-8 encoding and then encoding each of the
     * resulting bytes as a %xx hexadecimal escape sequence.
     * <p>
     * Note: this method will convert any the space character into its escape
     * short form, '+' rather than %20. It should therefore only be used for
     * query-string parts.
     *
     * <p>
     * The following character sets are <em>not</em> escaped by this method:
     * <ul>
     * <li>ASCII digits or letters</li>
     * <li>ASCII punctuation characters:
     *
     * <pre>- _ . ! ~ * ' ( )</pre>
     * </li>
     * </ul>
     * </p>
     *
     * <p>
     * Notice that this method <em>does</em> encode the URL component delimiter
     * characters:<blockquote>
     *
     * <pre>
     * ; / ? : &amp; = + $ , #
     * </pre>
     *
     * </blockquote>
     * </p>
     *
     * @param {String} str A string containing invalid URL characters
     * @return {String} a string with all invalid URL characters escaped
     */
    encodeQueryString(str) {
      if (!str) {
        return str;
      }
      const regexp = /%20/g;
      return encodeURIComponent(str).replace(regexp, '+');
    }
    /**
     * Returns a string where all URL component escape sequences have been
     * converted back to their original character representations.
     *
     * Note: this method will convert the space character escape short form, '+',
     * into a space. It should therefore only be used for query-string parts.
     *
     * @param {String} str string containing encoded URL component sequences
     * @return {String} string with no encoded URL component encoded sequences
     */
    decodeQueryString(str) {
      if (!str) {
        return str;
      }
      const regexp = /\+/g;
      return decodeURIComponent(str.replace(regexp, '%20'));
    }
    /**
     * A trick to instantly replace main URL input with host field and back
     * without animation jumping when transitioning.
     * Sets / removes `sized` class name from the collapse element. This class
     * sets minimum height for the element so the host field will be visible
     * instantly in place of dissapearing main URL.
     *
     * @param {Boolean} value
     * @param {Boolean} oldValue
     */
    _colapseTransitioning(value, oldValue) {
      if (oldValue === undefined) {
        return;
      }
      if (value && this.detailsOpened) {
        this.$.collapse.classList.add('sized');
      } else if (value && !this.detailsOpened) {
        this.$.collapse.classList.remove('sized');
      }
    }
    /**
     * Validates the element.
     * @return {Boolean}
     */
    _getValidity() {
      if (!this.shadowRoot) {
        return true;
      }
      let element;
      if (this.detailsOpened) {
        element = this.shadowRoot.querySelector('url-detailed-editor');
      } else {
        element = this.shadowRoot.querySelector('.main-input');
      }
      return element.validate();
    }
    /**
     * Fired when the URL value change.
     * Note that this event is fired before validation occur and therefore
     * the URL may be invalid.
     *
     * @event url-value-changed
     * @param {String} value The URL.
     * @param {Array<Object>} queryParameters Optional query parameters model.
     */
    /**
     * Fired when the user use the "entrer" key in any of the fields.
     *
     * @event send-request
     */
    /**
     * Fired when autocomplete element request data.
     * This event is to be handled by `url-history-saver` element but it can be
     * handled by any element that intercepts this event.
     *
     * @event url-history-query
     * @param {String} q A query filter.
     */
  }
  window.customElements.define(UrlInputEditor.is, UrlInputEditor);
  </script>
</dom-module>
