<!--
@license
Copyright 2017 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../events-target-behavior/events-target-behavior.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="url-detailed-editor.html">
<script src="url-parser.js"></script>
<!--
# url-input-editor element

An editor of the request URL.

The editor renders a simple editor view with a input fiedl. The input in this
view is supported by the `paper-autocomplete` element that queries history saver
for URL history data (`url-history-query` custom event).


By setting `detailsOpened` property to `true` (the user can do this in the UI)
it will render detailed editor. The editor allows to edit host, path, query
parameetrs and hash separatelly.


### Example

```html
<url-input-editor url="{{requestURL}}" on-send-request="_sendAction" on-url-value-changed="_handleNewUrl"></url-input-editor>
```

### Styling
`<url-input-editor>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--url-input-editor` | Mixin applied to the element | `{}`

Use paper elements mixin to style this element.

@group UI Elements
@element url-input-editor
@demo demo/index.html
-->
<dom-module id="url-input-editor">
  <template>
    <style>
    :host {
      @apply(--layout-vertical);
      position: relative;
      @apply(--url-input-editor);
    }

    .content {
      @apply(--layout-horizontal);
    }

    .main-input,
    .editor {
      @apply(--layout-flex);
    }

    paper-autocomplete {
      bottom: 0;
    }

    #detailedOpen {
      @apply --toggle-button;
      padding: 0;
      width: 24px;
      height: 24px;
    }

    #detailedOpen:hover {
      @apply --toggle-button-hover;
    }

    iron-collapse.sized {
      min-height: 48px;
    }
    </style>
    <div class="content">
      <div class="editor">
        <paper-input label="Request URL" value="{{value}}" class="main-input" required auto-validate error-message="An URL is required." hidden="[[detailsOpened]]" on-blur="_ensureUrlHasProtocol">
          <paper-icon-button id="detailedOpen" suffix icon="arc:keyboard-arrow-down" on-tap="open"></paper-icon-button>
        </paper-input>
        <paper-autocomplete loader open-on-focus target="[[_autocompleteTarget]]" on-query="_autocompleteQuery" opened="{{suggesionsOpened}}"></paper-autocomplete>
        <iron-collapse id="collapse" opened="[[detailsOpened]]" transitioning="{{colapseTransitioning}}">
          <url-detailed-editor value="{{value}}" attr-for-opened="opened" opened$="[[detailsOpened]]" details-opened="{{detailsOpened}}" on-url-encode="encodeParameters" on-url-decode="decodeParameters"></url-detailed-editor>
        </iron-collapse>
      </div>
      <paper-tooltip animation-delay="200" for="detailedOpen">Open detailed editor</paper-tooltip>
    </div>
  </template>
  <script>
  Polymer({
    is: 'url-input-editor',

    behaviors: [
      ArcBehaviors.EventsTargetBehavior,
      Polymer.IronValidatableBehavior,
      Polymer.IronFormElementBehavior
    ],

    /**
     * Fired when the URL value change.
     * Note that this event is fired before validation occur and therefore
     * the URL may be invalid.
     *
     * @event url-value-changed
     * @param {String} value The URL.
     */
    /**
     * Fired when the user use the "entrer" key in any of the fields.
     *
     * @event send-request
     */
    /**
     * Fired when autocomplete element request data.
     * This event is to be handled by `url-history-saver` element but it can be
     * handled by any element that intercepts this event.
     *
     * @event url-history-query
     * @param {String} q A query filter.
     */
    properties: {
      // Current URL value.
      value: {
        type: String,
        notify: true,
        observer: '_onValueChanged'
      },
      /**
       * True if detailed editor is opened.
       */
      detailsOpened: Boolean,
      /**
       * Default protocol for the URL if it's missing.
       */
      defaultProtocol: {
        type: String,
        value: 'https'
      },
      /**
       * Input target for the `paper-autocomplete` element.
       */
      _autocompleteTarget: {
        type: HTMLElement,
        value: function() {
          return this.$$('.main-input');
        }
      },
      // True when a suggestion box for the URL is opened.
      suggesionsOpened: {
        type: Boolean,
        notify: true
      },
      // Controlled by the collapse element flad used to animate detail panel.
      colapseTransitioning: {
        type: Boolean,
        observer: '_colapseTransitioning'
      }
    },

    observers: ['_detailsOpenedChanged(detailsOpened)'],

    listeners: {
      'keydown': '_keyDownHandler'
    },

    ready: function() {
      this._ready = true;
    },

    _attachListeners: function(node) {
      this.listen(node, 'url-value-changed', '_extValueChangedHandler');
    },

    _detachListeners: function(node) {
      this.unlisten(node, 'url-value-changed', '_extValueChangedHandler');
    },
    /**
     * A handler that is called on input
     */
    _onValueChanged: function() {
      if (!this._ready || this._preventValueChangeEvent) {
        return;
      }
      this.fire('url-value-changed', {
        value: this.value
      });
    },

    /**
     * A handler for the `url-value-changed` event.
     * If this element is not the source of the event then it will update the `value` property.
     * It's to be used besides the Polymer's data binding system.
     */
    _extValueChangedHandler: function(e) {
      if (e.target === this) {
        return;
      }
      this._preventValueChangeEvent = true;
      this.set('value', e.detail.value);
      this._preventValueChangeEvent = false;
    },

    /**
     * Opens detailed view.
     */
    open: function() {
      this.detailsOpened = true;
    },

    /**
     * HTTP encode query parameters
     */
    encodeParameters: function() {
      this._decodeEncode('encode');
      this.fire('send-analytics', {
        type: 'event',
        category: 'Request view',
        action: 'URL widget context menu action',
        label: 'Encode parameters'
      });
    },

    /**
     * HTTP decode query parameters
     */
    decodeParameters: function() {
      this._decodeEncode('decode');
      this.fire('send-analytics', {
        type: 'event',
        category: 'Request view',
        action: 'URL widget context menu action',
        label: 'Decode parameters'
      });
    },

    /**
     * HTTP encode or decode query parameters depending on [type].
     */
    _decodeEncode: function(type) {
      var url = this.value;
      if (!url) {
        return;
      }
      var parser = new UrlParser(url);
      if (type === 'decode') {
        this._decode(parser);
      } else {
        this._encode(parser);
      }
    },

    _decode: function(parser) {
      var decoded = parser.searchParams.map(function(item) {
        var _key = this.decodeQueryString(item[0]);
        var _value = this.decodeQueryString(item[1]);
        return [_key, _value];
      }, this);
      parser.searchParams = decoded;
      var path = parser.path;
      if (path) {
        parser.path = path.split('/')
        .map(function(item) {
          return this.decodeQueryString(item);
        }, this)
        .join('/');
      }
      this.set('value', parser.value);
    },

    _encode: function(parser) {
      var encoded = parser.searchParams.map(function(item) {
        var _key = this.encodeQueryString(item[0]);
        var _value = this.encodeQueryString(item[1]);
        return [_key, _value];
      }, this);
      parser.searchParams = encoded;
      var path = parser.path;
      if (path) {
        parser.path = '/' + path.split('/')
        .map(function(item) {
          if (!item) {
            return;
          }
          return this.encodeQueryString(item);
        }, this)
        .filter(function(item) {
          return !!item;
        })
        .join('/');
      }
      this.set('value', parser.value);
    },

    _detailsOpenedChanged: function(detailsOpened) {
      if (detailsOpened) {
        return;
      }
      this._ensureUrlHasProtocol();
    },

    _autocompleteQuery: function(e) {
      e.preventDefault();
      e.stopPropagation();
      var autocomplete = e.target;

      if (!e.detail.value) {
        autocomplete.source = [];
        return;
      }
      var event = this.fire('url-history-query', {
        q: e.detail.value
      }, {
        cancelable: true
      });
      if (event.defaultPrevented && !event.detail.error) {
        event.detail.result.then(function(result) {
          result = result.map(function(item) {
            return item.url;
          });
          autocomplete.source = result;
        });
      } else {
        autocomplete.source = [];
      }
    },
    /**
     * Ensures that the URL has a protocol.
     * The detault protocol is defined in `defaultProtocol` property.
     * The protocol is inserted into the URL value only if the value is not a
     * path and it's not a variable.
     *
     * @return {undefined} It updates the `url` property.
     */
    _ensureUrlHasProtocol: function() {
      var url = this.value;
      if (url.indexOf('http') !== 0) {
        if (url[0] !== '/' && url[0] !== '$' && url[0] !== '{') {
          url = this.defaultProtocol + '://' + url;
          this.set('value', url);
        }
      }
    },
    _keyDownHandler: function(e) {
      e = Polymer.dom(e);
      if (e.rootTarget.nodeName !== 'INPUT') {
        return;
      }
      if (e.event.keyCode !== 13) {
        return;
      }
      this._onEnter();
    },
    /**
     * A handler called when the user press "enter" in any of the form fields.
     * This will send a `send` event.
     */
    _onEnter: function() {
      if (this.suggesionsOpened) {
        return;
      }
      this.fire('send-request');
    },
    /**
     * Returns a string where all characters that are not valid for a URL
     * component have been escaped. The escaping of a character is done by
     * converting it into its UTF-8 encoding and then encoding each of the
     * resulting bytes as a %xx hexadecimal escape sequence.
     * <p>
     * Note: this method will convert any the space character into its escape
     * short form, '+' rather than %20. It should therefore only be used for
     * query-string parts.
     *
     * <p>
     * The following character sets are <em>not</em> escaped by this method:
     * <ul>
     * <li>ASCII digits or letters</li>
     * <li>ASCII punctuation characters:
     *
     * <pre>- _ . ! ~ * ' ( )</pre>
     * </li>
     * </ul>
     * </p>
     *
     * <p>
     * Notice that this method <em>does</em> encode the URL component delimiter
     * characters:<blockquote>
     *
     * <pre>
     * ; / ? : &amp; = + $ , #
     * </pre>
     *
     * </blockquote>
     * </p>
     *
     * @param {String} str A string containing invalid URL characters
     * @return {String} a string with all invalid URL characters escaped
     */
    encodeQueryString: function(str) {
      if (!str) {
        return str;
      }
      var regexp = /%20/g;
      return encodeURIComponent(str).replace(regexp, '+');
    },
    /**
     * Returns a string where all URL component escape sequences have been
     * converted back to their original character representations.
     *
     * Note: this method will convert the space character escape short form, '+',
     * into a space. It should therefore only be used for query-string parts.
     *
     * @param {String} str string containing encoded URL component sequences
     * @return {String} string with no encoded URL component encoded sequences
     */
    decodeQueryString: function(str) {
      if (!str) {
        return str;
      }
      var regexp = /\+/g;
      return decodeURIComponent(str.replace(regexp, '%20'));
    },
    /**
     * A trick to instantly replace main URL input with host field and back
     * without animation jumping when transitioning.
     * Sets / removes `sized` class name from the collapse element. This class
     * sets minimum height for the element so the host field will be visible
     * instantly in place of dissapearing main URL.
     */
    _colapseTransitioning: function(value, oldValue) {
      if (oldValue === undefined) {
        return;
      }
      if (value && this.detailsOpened) {
        this.$.collapse.classList.add('sized');
      } else if (value && !this.detailsOpened) {
        this.$.collapse.classList.remove('sized');
      }
    }
  });
  </script>
</dom-module>
